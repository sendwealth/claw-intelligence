name: CEO Hourly Check

on:
  schedule:
    # Every hour at minute 0
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  hourly-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current time
        id: time
        run: echo "now=$(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_OUTPUT

      - name: Check team progress
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read team board
            let teamBoard = '';
            try {
              teamBoard = fs.readFileSync('agents/TEAM_BOARD.md', 'utf8');
            } catch (e) {
              console.log('Team board not found');
            }

            // Get open issues (tasks)
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'customer-inquiry',
              per_page: 10
            });

            // Get recent commits
            const commits = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 5
            });

            // Generate hourly report
            const report = `## ğŸ‹ CEO æ¯å°æ—¶æ£€æŸ¥æŠ¥å‘Š

**æ—¶é—´ï¼š** ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}

---

### ğŸ“Š ç³»ç»ŸçŠ¶æ€

| æŒ‡æ ‡ | çŠ¶æ€ |
|------|------|
| ç½‘ç«™ | âœ… è¿è¡Œä¸­ |
| è‡ªåŠ¨åŒ– | âœ… æ´»è·ƒ |
| å¾…å¤„ç†å’¨è¯¢ | ${issues.data.length} |
| ä»Šæ—¥æäº¤ | ${commits.data.length} |

---

### ğŸ“¬ å¾…å¤„ç†å’¨è¯¢

${issues.data.length > 0 ? 
  issues.data.map(i => `- [#${i.number}] ${i.title}`).join('\n') :
  'âœ… æ— å¾…å¤„ç†å’¨è¯¢'}

---

### ğŸ“ æœ€è¿‘æäº¤

${commits.data.slice(0, 3).map(c => 
  `- ${c.commit.message.split('\n')[0]}`
).join('\n')}

---

### ğŸ¯ å»ºè®®è¡ŒåŠ¨

${issues.data.length > 0 ? 
  'âš ï¸ **æœ‰å¾…å¤„ç†å’¨è¯¢ï¼Œè¯·å°½å¿«å›å¤ï¼**' : 
  'âœ… ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼Œç»§ç»­æ¨å¹¿è·å®¢ã€‚'}

---

*è‡ªåŠ¨ç”Ÿæˆ by CEO uc ğŸ‹*
`;

            // Update team board with timestamp
            const updatedBoard = teamBoard.replace(
              /\*\*æ›´æ–°æ—¶é—´ï¼š\*\*.*/,
              `**æ›´æ–°æ—¶é—´ï¼š** ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}`
            );
            fs.writeFileSync('agents/TEAM_BOARD.md', updatedBoard);

            // Create hourly check issue (only if there are pending items)
            if (issues.data.length > 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `â° æ¯å°æ—¶æ£€æŸ¥ - ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}`,
                body: report,
                labels: ['hourly-check', 'auto-generated']
              });
            }

            console.log('âœ… Hourly check completed!');

      - name: Commit updates
        run: |
          git config --local user.email "ceo@claw.ai"
          git config --local user.name "uc (AI CEO)"
          git add -A
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ¤– CEO hourly check update"
          git push
