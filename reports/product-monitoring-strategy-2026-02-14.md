# CLAW.AI 产品监控和告警体系

**文档版本:** v1.0
**创建日期:** 2026-02-14
**负责人:** 产品监控团队

---

## 1. 概述

### 1.1 监控目标

CLAW.AI 产品监控体系的目标是：
- **实时感知**：实时掌握产品运行状态和用户行为
- **快速响应**：及时发现并处理异常情况
- **数据驱动**：通过数据分析优化产品和业务决策
- **持续改进**：建立反馈循环，持续提升产品质量

### 1.2 监控架构

```
┌─────────────────────────────────────────────────────────┐
│                    数据采集层                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 用户行为  │  │ 产品指标  │  │ 技术指标  │  │ 业务指标  │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                    数据处理层                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 数据清洗  │  │ 数据聚合  │  │ 数据存储  │  │ 数据计算  │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                    监控分析层                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 指标监控  │  │ 异常检测  │  │ 趋势分析  │  │ 告警触发  │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                    可视化和通知层                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 数据看板  │  │ 飞书通知  │  │ 邮件通知  │  │ 短信/电话 │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

## 2. 监控维度设计

### 2.1 用户行为监控

#### 2.1.1 用户注册数

**指标定义：**
- 日注册数：当天新注册用户数量
- 周注册数：当周新注册用户数量
- 月注册数：当月新注册用户数量

**数据采集：**
- 采集点：用户注册成功事件
- 采集频率：实时
- 存储粒度：按天聚合

**告警规则：**
- P2：日注册数环比下降 > 30%

#### 2.1.2 活跃用户数

**指标定义：**
- DAU（Daily Active Users）：日活跃用户数
- MAU（Monthly Active Users）：月活跃用户数
- DAU/MAU：用户活跃度比率

**数据采集：**
- 采集点：用户任何交互行为（登录、对话、功能使用等）
- 采集频率：实时
- 存储粒度：按天聚合

**告警规则：**
- P2：DAU 环比下降 > 20%
- P2：DAU/MAU 下降 > 10%

#### 2.1.3 用户留存率

**指标定义：**
- 次日留存：注册后第2天仍活跃的用户比例
- 7日留存：注册后第7天仍活跃的用户比例
- 30日留存：注册后第30天仍活跃的用户比例

**数据采集：**
- 采集点：用户首次注册时间 + 后续活跃时间
- 采集频率：每天计算
- 存储粒度：按用户和日期存储

**告警规则：**
- P3：次日留存率 < 20%
- P3：7日留存率 < 10%
- P3：30日留存率 < 5%

#### 2.1.4 功能使用率

**指标定义：**
- 各功能模块的日使用次数
- 各功能模块的活跃用户数
- 功能渗透率（使用该功能的用户 / 总活跃用户）

**数据采集：**
- 采集点：每个功能模块的调用事件
- 采集频率：实时
- 存储粒度：按天聚合

**告警规则：**
- P3：核心功能使用率环比下降 > 15%
- P3：新功能 7 日渗透率 < 5%

#### 2.1.5 用户路径分析

**指标定义：**
- 用户会话路径：用户在一次会话中的操作序列
- 关键路径转化率：从进入页面到完成关键操作的转化率
- 路径流失点：用户流失最多的环节

**数据采集：**
- 采集点：用户每次操作事件
- 采集频率：实时
- 存储粒度：保留原始事件流

**告警规则：**
- P3：关键路径转化率下降 > 10%

---

### 2.2 产品指标监控

#### 2.2.1 AI 对话成功率

**指标定义：**
- 成功对话数 / 总对话数
- 成功定义：AI 完整响应且用户认可

**数据采集：**
- 采集点：AI 对话开始和结束事件
- 采集频率：实时
- 存储粒度：按小时聚合

**告警规则：**
- P1：成功率 < 90%
- P2：成功率 < 95%

#### 2.2.2 AI 响应时间

**指标定义：**
- P50：50% 的请求响应时间
- P95：95% 的请求响应时间
- P99：99% 的请求响应时间

**数据采集：**
- 采集点：AI 对话请求和响应时间戳
- 采集频率：实时
- 存储粒度：按小时聚合

**告警规则：**
- P2：P95 > 3 秒
- P1：P99 > 5 秒

#### 2.2.3 问题解决率

**指标定义：**
- 用户标记"已解决"的对话数 / 总对话数
- 用户满意度 4-5 星的对话数 / 总对话数

**数据采集：**
- 采集点：用户满意度反馈
- 采集频率：实时
- 存储粒度：按天聚合

**告警规则：**
- P3：问题解决率 < 80%
- P3：满意度评分 < 4.0

#### 2.2.4 知识库覆盖率

**指标定义：**
- AI 能直接回答的问题数 / 总问题数
- 需要转人工的问题比例

**数据采集：**
- 采集点：AI 回答来源（知识库 / 生成 / 转人工）
- 采集频率：实时
- 存储粒度：按天聚合

**告警规则：**
- P2：知识库覆盖率 < 70%

#### 2.2.5 客户满意度评分

**指标定义：**
- 平均满意度评分（1-5 星）
- 各评分分布比例
- NPS（净推荐值）估算

**数据采集：**
- 采集点：用户满意度反馈
- 采集频率：实时
- 存储粒度：按天聚合

**告警规则：**
- P3：平均评分 < 4.0
- P3：差评率（1-2 星）> 15%

---

### 2.3 技术指标监控

#### 2.3.1 API 可用性

**指标定义：**
- Uptime = (总时间 - 不可用时间) / 总时间
- 月度可用性目标：99.9%

**数据采集：**
- 采集点：HTTP 请求状态码
- 采集频率：每分钟探测
- 存储粒度：按分钟聚合

**告警规则：**
- P0：不可用持续 > 5 分钟
- P1：不可用持续 > 15 分钟

#### 2.3.2 API 响应时间

**指标定义：**
- 平均响应时间
- P95/P99 响应时间

**数据采集：**
- 采集点：每个 API 请求的耗时
- 采集频率：实时
- 存储粒度：按分钟聚合

**告警规则：**
- P1：P95 > 5 秒
- P2：P95 > 3 秒

#### 2.3.3 错误率

**指标定义：**
- HTTP 5xx 错误率
- HTTP 4xx 错误率
- 业务错误率

**数据采集：**
- 采集点：每个 API 请求的状态码
- 采集频率：实时
- 存储粒度：按分钟聚合

**告警规则：**
- P2：错误率 > 5%
- P1：错误率 > 10%

#### 2.3.4 数据库连接数

**指标定义：**
- 当前活跃连接数
- 连接池使用率

**数据采集：**
- 采集点：数据库监控接口
- 采集频率：每 30 秒
- 存储粒度：按分钟聚合

**告警规则：**
- P1：连接数 > 80% 最大连接数
- P0：连接数 = 100% 最大连接数

#### 2.3.5 Redis 命中率

**指标定义：**
- 命中率 = 命中次数 / (命中次数 + 未命中次数)

**数据采集：**
- 采集点：Redis INFO 命令
- 采集频率：每分钟
- 存储粒度：按分钟聚合

**告警规则：**
- P2：命中率 < 60%
- P3：命中率 < 70%

#### 2.3.6 服务器资源使用率

**指标定义：**
- CPU 使用率
- 内存使用率
- 磁盘使用率
- 网络带宽使用率

**数据采集：**
- 采集点：系统监控接口（如 Prometheus）
- 采集频率：每 30 秒
- 存储粒度：按分钟聚合

**告警规则：**
- P1：CPU 使用率 > 90% 持续 10 分钟
- P1：内存使用率 > 90%
- P2：磁盘使用率 > 85%

---

### 2.4 业务指标监控

#### 2.4.1 订阅数增长

**指标定义：**
- 新增订阅数
- 取消订阅数
- 净增订阅数

**数据采集：**
- 采集点：订阅/取消订阅事件
- 采集频率：实时
- 存储粒度：按天聚合

**告警规则：**
- P2：订阅净增长为负
- P3：新增订阅数环比下降 > 20%

#### 2.4.2 续费率

**指标定义：**
- 续费用户数 / 到期用户数
- 按订阅周期统计（月度、年度）

**数据采集：**
- 采集点：续费事件
- 采集频率：按天计算
- 存储粒度：按月聚合

**告警规则：**
- P2：续费率 < 70%
- P3：续费率 < 80%

#### 2.4.3 客户流失率（Churn Rate）

**指标定义：**
- 流失客户数 / 期初客户数
- 按月统计

**数据采集：**
- 采集点：用户取消订阅或长期未活跃
- 采集频率：按天计算
- 存储粒度：按月聚合

**告警规则：**
- P2：月流失率 > 10%
- P3：月流失率 > 5%

#### 2.4.4 平均客单价（ARPA）

**指标定义：**
- 月度总营收 / 月活跃用户数

**数据采集：**
- 采集点：订单和用户数据
- 采集频率：按天计算
- 存储粒度：按月聚合

**告警规则：**
- P3：ARPA 环比下降 > 10%

#### 2.4.5 客户生命周期价值（LTV）

**指标定义：**
- 平均每位客户在生命周期内贡献的收入

**数据采集：**
- 采集点：历史订单数据
- 采集频率：按月计算
- 存储粒度：按月聚合

**告警规则：**
- P3：LTV 环比下降 > 10%

---

## 3. 技术实现方案

### 3.1 技术栈选择

| 层级 | 技术方案 | 说明 |
|------|---------|------|
| 数据采集 | 自研埋点 SDK + Prometheus | 用户行为埋点 + 技术指标采集 |
| 数据存储 | ClickHouse + PostgreSQL | 时序数据 + 关系数据 |
| 数据处理 | Apache Flink | 实时流处理 |
| 可视化 | Grafana + 自研看板 | 技术监控 + 业务分析 |
| 告警系统 | AlertManager + 自研告警 | 规则引擎 + 通知分发 |

### 3.2 数据架构

```
事件数据 → Kafka → Flink → ClickHouse (时序数据)
                            ↓
                      PostgreSQL (业务数据)
                            ↓
                      Grafana (可视化)
                            ↓
                      AlertManager (告警)
```

### 3.3 埋点规范

#### 3.3.1 事件命名规范

格式：`{模块}_{操作}_{对象}`

示例：
- `user_register_success` - 用户注册成功
- `ai_dialog_start` - AI 对话开始
- `feature_click_dashboard` - 点击看板功能

#### 3.3.2 通用字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| event_id | string | 事件唯一 ID |
| user_id | string | 用户 ID |
| session_id | string | 会话 ID |
| timestamp | long | 时间戳（毫秒） |
| platform | string | 平台（web/mobile/api） |
| version | string | 产品版本 |

#### 3.3.3 用户行为事件示例

```json
{
  "event_id": "evt_20260214_123456",
  "event_name": "user_register_success",
  "user_id": "user_abc123",
  "session_id": "sess_xyz789",
  "timestamp": 1739496000000,
  "platform": "web",
  "version": "1.0.0",
  "properties": {
    "source": "invitation",
    "referral_code": "INV2024"
  }
}
```

---

## 4. 实施计划

### 4.1 第一阶段（Week 1-2）
- [x] 完成监控体系设计
- [ ] 部署基础监控基础设施
- [ ] 实现技术指标采集
- [ ] 创建基础数据看板

### 4.2 第二阶段（Week 3-4）
- [ ] 集成用户行为埋点
- [ ] 实现产品指标计算
- [ ] 配置告警规则
- [ ] 测试告警通知

### 4.3 第三阶段（Week 5-6）
- [ ] 优化数据看板
- [ ] 完善告警规则
- [ ] 编写运维文档
- [ ] 培训运维团队

### 4.4 第四阶段（Week 7-8）
- [ ] 全量上线
- [ ] 监控效果评估
- [ ] 持续优化调整

---

## 5. 运维规范

### 5.1 告警响应流程

1. **接收告警**：运维人员通过飞书/短信接收告警
2. **初步评估**：5 分钟内确认告警级别和影响范围
3. **处理告警**：根据级别在规定时间内响应和解决
4. **记录处理**：更新问题跟踪系统
5. **复盘分析**：每周复盘重大告警，优化规则

### 5.2 监控数据维护

- **数据保留策略**：原始数据保留 30 天，聚合数据保留 1 年
- **告警规则 review**：每月 review 告警规则，减少误报
- **指标新增流程**：新指标需要评审和审批

### 5.3 安全和隐私

- 所有用户数据脱敏处理
- 监控数据访问权限控制
- 定期审计监控数据访问日志

---

## 6. 附录

### 6.1 相关文档
- [告警规则文档](/home/wuying/clawd/claw-ai-backend/docs/ALERTING_RULES.md)
- [用户行为监控配置](/home/wuying/clawd/claw-ai-backend/docs/USER_BEHAVIOR_MONITORING.md)
- [产品指标看板](/home/wuying/clawd/claw-ai-backend/docs/PRODUCT_METRICS_DASHBOARD.md)
- [问题诊断流程](/home/wuying/clawd/claw-ai-backend/docs/INCIDENT_MANAGEMENT.md)
- [告警通知配置](/home/wuying/clawd/claw-ai-backend/config/alerting.yaml)

### 6.2 联系人
- 产品负责人：[待填写]
- 技术负责人：[待填写]
- 运维负责人：[待填写]

---

**文档结束**
